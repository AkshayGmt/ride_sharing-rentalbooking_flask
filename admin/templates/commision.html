<div class="container my-4">
  <h2>Platform Commission Management</h2>

  <!-- Add Commission Rule -->
  <div class="card mb-4">
    <div class="card-header">Add New Commission Rule</div>
    <div class="card-body">
      <form action="{{ url_for('commission.create_commission') }}" method="POST" class="row g-2">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="col-md-3">
          <input type="text" name="vehicle_type" placeholder="Vehicle Type (Car/Bike)" class="form-control" required>
        </div>
        <div class="col-md-3">
          <input type="text" name="ride_type" placeholder="Ride Type (On-Demand/Scheduled)" class="form-control" required>
        </div>
        <div class="col-md-2">
          <input type="number" name="commission_percentage" placeholder="Commission %" class="form-control" step="0.01" required>
        </div>
        <div class="col-md-2">
          <input type="number" name="first_time_user_extra" placeholder="First Time Extra %" class="form-control" step="0.01">
        </div>
        <div class="col-md-2">
          <label class="form-check-label">
            <input type="checkbox" name="promo_applies" checked> Promo Applies
          </label>
        </div>
        <div class="col-md-12 mt-2">
          <button class="btn btn-primary">Add Rule</button>
        </div>
      </form>
    </div>
  </div>
<form action="{{ url_for('commission.import_commissions') }}" method="POST" enctype="multipart/form-data">
    <input type="file" name="csv_file" accept=".csv" required>
    <button class="btn btn-primary btn-sm">Upload CSV</button>
</form>

  <!-- Commission Rules Table -->
  <div class="card">
    <div class="card-header">Existing Commission Rules</div>
    <div class="card-body">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Vehicle Type</th>
            <th>Ride Type</th>
            <th>Commission %</th>
            <th>First Time Extra %</th>
            <th>Promo Applies</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for rule in rules %}
          <tr>
            <td>{{ rule.vehicle_type }}</td>
            <td>{{ rule.ride_type }}</td>
            <td>{{ rule.commission_percentage }}</td>
            <td>{{ rule.first_time_user_extra }}</td>
            <td>{{ 'Yes' if rule.promo_applies else 'No' }}</td>
            <td>
              <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editRule{{ rule.id }}">Edit</button>
            </td>
          </tr>

          <!-- Edit Modal -->
          <div class="modal fade" id="editRule{{ rule.id }}" tabindex="-1">
           <div class="card my-4">
  <div class="card-header">Commission Rules - Inline Editing</div>
  <div class="card-body">
    <table class="table table-striped table-hover" id="commissionTable">
      <thead>
        <tr>
          <th>Vehicle Type</th>
          <th>Ride Type</th>
          <th>Commission %</th>
          <th>First Time Extra %</th>
          <th>Promo Applies</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for rule in rules %}
        <tr data-id="{{ rule.id }}">
          <td><input type="text" class="form-control form-control-sm vehicle_type" value="{{ rule.vehicle_type }}"></td>
          <td><input type="text" class="form-control form-control-sm ride_type" value="{{ rule.ride_type }}"></td>
          <td><input type="number" class="form-control form-control-sm commission_percentage" value="{{ rule.commission_percentage }}" step="0.01"></td>
          <td><input type="number" class="form-control form-control-sm first_time_user_extra" value="{{ rule.first_time_user_extra }}" step="0.01"></td>
          <td><input type="checkbox" class="promo_applies" {% if rule.promo_applies %}checked{% endif %}></td>
          <td><button class="btn btn-sm btn-success save-row">Save</button></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
document.querySelectorAll('.save-row').forEach(button => {
    button.addEventListener('click', function(){
        let row = button.closest('tr');
        let rule_id = row.dataset.id;

        fetch(`/admin/commissions/${rule_id}/edit-inline`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
                vehicle_type: row.querySelector('.vehicle_type').value,
                ride_type: row.querySelector('.ride_type').value,
                commission_percentage: row.querySelector('.commission_percentage').value,
                first_time_user_extra: row.querySelector('.first_time_user_extra').value,
                promo_applies: row.querySelector('.promo_applies').checked
            })
        }).then(res => res.json()).then(data=>{
            if(data.success){
                alert('Row updated successfully!');
            } else { alert('Update failed'); }
        });
    });
});
</script>

          </div>

          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="card my-3">
  <div class="card-header">Fare Preview for First-Time Users</div>
  <div class="card-body">
    <label>Vehicle Type: <input type="text" id="preview_vehicle" class="form-control form-control-sm"></label>
    <label>Ride Type: <input type="text" id="preview_ride" class="form-control form-control-sm"></label>
    <label>Base Fare: <input type="number" id="preview_base" class="form-control form-control-sm"></label>
    <label>Promo Discount: <input type="number" id="preview_promo" class="form-control form-control-sm" value="0"></label>
    <button id="preview_btn" class="btn btn-info btn-sm mt-2">Calculate Fare</button>
    <p id="fare_result"></p>
  </div>
</div>

<script>
document.getElementById('preview_btn').addEventListener('click', ()=>{
    let vehicle = document.getElementById('preview_vehicle').value;
    let ride = document.getElementById('preview_ride').value;
    let base = parseFloat(document.getElementById('preview_base').value || 0);
    let promo = parseFloat(document.getElementById('preview_promo').value || 0);

    // find commission rule
    let row = [...document.querySelectorAll('#commissionTable tbody tr')].find(r=>r.querySelector('.vehicle_type').value===vehicle && r.querySelector('.ride_type').value===ride);
    if(!row){ alert('Rule not found'); return; }

    let commission = parseFloat(row.querySelector('.commission_percentage').value);
    let first_time_extra = parseFloat(row.querySelector('.first_time_user_extra').value);

    let fare = base + base * (commission + first_time_extra)/100 - promo;
    document.getElementById('fare_result').innerText = "Estimated Fare: â‚¹" + fare.toFixed(2);
});
</script>

</div>
