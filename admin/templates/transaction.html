{% extends 'admin/base.html' %}
{% block content %}
<div class="container mx-auto p-4">
    <h2 class="text-2xl font-bold mb-4">Track All Transactions</h2>

    <!-- Filters -->
    <div class="flex gap-4 mb-4">
        <input type="text" id="user_id" placeholder="User ID" class="border p-2 rounded">
        <select id="transaction_type" class="border p-2 rounded">
            <option value="">All Types</option>
            <option value="ride_payment">Ride Payment</option>
            <option value="rental_payment">Rental Payment</option>
            <option value="wallet_topup">Wallet Top-up</option>
            <option value="driver_payout">Driver Payout</option>
            <option value="refund">Refund</option>
        </select>
        <select id="status" class="border p-2 rounded">
            <option value="">All Status</option>
            <option value="pending">Pending</option>
            <option value="completed">Completed</option>
            <option value="failed">Failed</option>
        </select>
        <button onclick="applyFilters()" class="bg-blue-500 text-white px-4 py-2 rounded">Filter</button>
        <button onclick="clearFilters()" class="bg-gray-300 px-4 py-2 rounded">Clear</button>
    </div>

    <!-- Transactions Table -->
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white border rounded">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-4 py-2 border">Transaction ID</th>
                    <th class="px-4 py-2 border">User ID</th>
                    <th class="px-4 py-2 border">User Type</th>
                    <th class="px-4 py-2 border">Transaction Type</th>
                    <th class="px-4 py-2 border">Amount (₹)</th>
                    <th class="px-4 py-2 border">Payment Method</th>
                    <th class="px-4 py-2 border">Status</th>
                    <th class="px-4 py-2 border">Date/Time</th>
                </tr>
            </thead>
            <tbody>
                {% for t in transactions %}
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 border">{{ t.transaction_id }}</td>
                    <td class="px-4 py-2 border">{{ t.user_id }}</td>
                    <td class="px-4 py-2 border">{{ t.user_type }}</td>
                    <td class="px-4 py-2 border">{{ t.transaction_type.replace('_',' ').title() }}</td>
                    <td class="px-4 py-2 border">₹{{ "%.2f"|format(t.amount) }}</td>
                    <td class="px-4 py-2 border">{{ t.payment_method.title() }}</td>
                    <td class="px-4 py-2 border">{{ t.status.title() }}</td>
                    <td class="px-4 py-2 border">{{ t.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

<div class="p-4 space-y-6">
    <!-- Filters -->
    <div class="flex space-x-4">
        <input type="text" id="filter_user" placeholder="User ID" class="input"/>
        <select id="filter_type" class="input">
            <option value="">All Types</option>
            <option value="ride">Ride</option>
            <option value="rental">Rental</option>
            <option value="wallet_topup">Wallet Top-Up</option>
            <option value="driver_payout">Driver Payout</option>
            <option value="refund">Refund</option>
        </select>
        <select id="filter_status" class="input">
            <option value="">All Status</option>
            <option value="pending">Pending</option>
            <option value="completed">Completed</option>
            <option value="failed">Failed</option>
        </select>
        <button onclick="loadTransactions()" class="btn-primary">Apply</button>
    </div>

    <!-- Transactions Table -->
    <table class="table-auto w-full border-collapse border">
        <thead class="bg-gray-100">
            <tr>
                <th>ID</th><th>User</th><th>Type</th><th>Amount</th><th>Commission</th><th>Status</th><th>Date</th>
            </tr>
        </thead>
        <tbody id="transactions_body"></tbody>
    </table>

    <!-- Analytics Chart -->
    <div class="p-4 bg-gray-50 rounded shadow">
        <canvas id="revenueChart" height="150"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chart;

async function loadTransactions() {
    const user = document.getElementById('filter_user').value;
    const type = document.getElementById('filter_type').value;
    const status = document.getElementById('filter_status').value;

    const params = new URLSearchParams({user_id: user, type: type, status: status});
    const res = await fetch('/admin/finance/transactions?' + params.toString());
    const data = await res.json();

    const tbody = document.getElementById('transactions_body');
    tbody.innerHTML = '';
    data.forEach(tx => {
        const row = `<tr>
            <td>${tx.id}</td>
            <td>${tx.user_id} (${tx.user_type})</td>
            <td>${tx.type}</td>
            <td>₹${tx.amount.toFixed(2)}</td>
            <td>₹${tx.commission.toFixed(2)}</td>
            <td>${tx.status}</td>
            <td>${new Date(tx.created_at).toLocaleString()}</td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
    });
    loadAnalytics();
}

async function loadAnalytics() {
    const res = await fetch('/admin/finance/transactions/analytics');
    const data = await res.json();

    const ctx = document.getElementById('revenueChart').getContext('2d');
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Daily','Weekly','Monthly','Total Commission'],
            datasets: [{
                label: 'Revenue/Commission ₹',
                data: [data.daily_revenue, data.weekly_revenue, data.monthly_revenue, data.total_commission],
                backgroundColor: ['#3B82F6','#10B981','#F59E0B','#EF4444']
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });
}

// Auto-refresh every 30 seconds
setInterval(loadTransactions, 30000);
loadTransactions();
</script>
