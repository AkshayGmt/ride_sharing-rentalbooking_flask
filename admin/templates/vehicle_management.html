<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin â€” Vehicle & Rental Management</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f4f6f9; font-family: Inter, system-ui, sans-serif; margin:0; }
    .layout { display:flex; min-height:100vh; }

    /* Sidebar */
    .sidebar {
      width:240px; background:#1e293b; color:#fff; padding:20px;
      display:flex; flex-direction:column; position:fixed; top:0; bottom:0; left:0;
    }
    .sidebar h2 { font-size:1.3rem; margin-bottom:20px; color:#f1f5f9; }
    .sidebar nav a {
      display:flex; align-items:center; gap:8px;
      color:#cbd5e1; text-decoration:none; padding:10px 12px; border-radius:8px;
      margin-bottom:6px; font-size:0.95rem; transition:0.2s;
    }
    .sidebar nav a:hover, .sidebar nav a.active {
      background:#334155; color:#fff;
    }

    /* Main content */
    .content { flex:1; margin-left:240px; padding:24px; }
    .content-header {
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:20px; border-bottom:1px solid #e2e8f0; padding-bottom:10px;
    }
    .card-ll {
      border-radius:14px; background:#fff;
      box-shadow:0 6px 20px rgba(15,30,50,0.05);
      padding:20px; margin-bottom:18px;
      transition:0.2s;
    }
    .card-ll:hover { box-shadow:0 8px 24px rgba(15,30,50,0.08); }

    /* Tables */
    .table thead th {
      position:sticky; top:0; background:#1e293b; color:#fff; border:none;
    }
    .table-striped tbody tr:nth-of-type(odd) {
      background:#f9fafb;
    }
    .table-hover tbody tr:hover { background:#f1f5f9; }

    /* Inputs & Buttons */
    .form-control, .form-select { border-radius:10px; }
    .btn { border-radius:10px; }
    .btn-primary { background:#2563eb; border:none; }
    .btn-ghost {
      background:transparent; border:1px solid #d0d7e6; color:#2563eb;
    }

    /* Misc */
    .img-thumb { width:64px; height:44px; object-fit:cover; border-radius:8px; border:1px solid #eee; }
    .small-muted { color:#6b7280; font-size:0.9rem; }
    .nav-tabs .nav-link { border-radius:10px; margin-right:6px; }
  </style>
</head>
<body>
<div class="layout">
  
  <!-- Sidebar -->
  <aside class="sidebar">
    <h2>Admin Panel</h2>
    <nav>
      <a href="{{ url_for('admin.admin_dashboard') }}">ðŸ“Š Dashboard</a>
      <a href="{{ url_for('admin.user_management') }}">ðŸ‘¤ Users</a>
      <a href="{{ url_for('admin.driver_management') }}">ðŸš– Drivers</a>
      <a href="{{ url_for('admin.vehicle_management') }}" class="active">ðŸš˜ Vehicles</a>
      <a href="{{ url_for('admin.ride_rental_management') }}">ðŸ›£ Rides</a>
      <a href="{{ url_for('admin.fare_pricing_dashboard') }}">ðŸ’° Pricing</a>
      <a href="{{ url_for('admin.payment_dashboard') }}">ðŸ’³ Finance</a>
      <a href="{{ url_for('admin.report_analiytics') }}">ðŸ“‘ Reports</a>
      <a href="{{ url_for('admin.notifications_alert') }}">ðŸ”” Alerts</a>
      <a href="{{ url_for('admin.admin_login') }}">ðŸšª Logout</a>
    </nav>
  </aside>

  <!-- Content -->
  <main class="content">
    <div class="content-header">
      <h3 class="mb-0">Vehicle & Rental Management</h3>
      <div class="small-muted">Manage vehicles â€¢ pricing â€¢ availability</div>
    </div>

    <!-- Tabs -->
    <div class="card-ll">
      <ul class="nav nav-tabs mb-3" id="vmTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#vehicles">Vehicles</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#pricing">Pricing</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#availability">Availability</button></li>
      </ul>

      <div class="tab-content">
        <!-- ================= Vehicles Tab ================= -->
        <div class="tab-pane fade show active" id="vehicles">
          <div class="row g-4">
            <div class="col-lg-4">
              <div class="p-3 bg-white rounded-3">
                <h6 class="mb-3">Add / Edit Vehicle</h6>
                <form id="vehicle-form">
                  <input type="hidden" name="vehicle_id" id="vehicle_id" value="">
                  <div class="mb-2">
                    <label class="form-label small-muted">Type</label>
                    <input class="form-control" name="vehicle_type" placeholder="Car, Van, Truck..." required>
                  </div>
                  <div class="mb-2">
                    <label class="form-label small-muted">Make & Model</label>
                    <input class="form-control" name="make_model" placeholder="Toyota Innova">
                  </div>
                  <div class="row g-2 mb-2">
                    <div class="col-6"><label class="form-label small-muted">Year</label><input class="form-control" name="year" type="number"></div>
                    <div class="col-6"><label class="form-label small-muted">Capacity</label><input class="form-control" name="capacity" type="number"></div>
                  </div>
                  <div class="mb-2"><label class="form-label small-muted">Fuel Type</label><input class="form-control" name="fuel_type"></div>
                  <div class="mb-2"><label class="form-label small-muted">Luggage / Cargo</label><input class="form-control" name="luggage_space"></div>
                  <div class="mb-2"><label class="form-label small-muted">Status</label>
                    <select class="form-select" name="status">
                      <option>Available</option><option>Booked</option><option>Maintenance</option><option>Disabled</option>
                    </select>
                  </div>

                  <!-- images: placeholder field (implement file upload server-side) -->
                  <div class="mb-2"><label class="form-label small-muted">Images</label><input class="form-control" type="file" name="images" multiple></div>

                  <div class="d-flex gap-2">
                    <button class="btn btn-primary" id="save-vehicle" type="submit">Save Vehicle</button>
                    <button class="btn btn-ghost" id="reset-vehicle" type="button">Reset</button>
                  </div>
                </form>
              </div>

              <div class="mt-3 small-muted">Tip: click a row in the list to edit a vehicle.</div>
            </div>

            <div class="col-lg-8">
              <div class="mb-2 d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Vehicle List</h6>
                <div class="flex-row-gap">
                  <input id="search-vehicle" class="form-control form-control-sm" style="width:220px;" placeholder="Search by type / model">
                  <select id="filter-status" class="form-select form-select-sm" style="width:160px;">
                    <option value="">All status</option>
                    <option>Available</option><option>Booked</option><option>Maintenance</option><option>Disabled</option>
                  </select>
                  <button class="btn btn-ghost btn-sm" id="refresh-list">Refresh</button>
                </div>
              </div>

              <div id="vehicle-table-wrap" style="max-height:520px; overflow:auto;">
                <table class="table table-hover align-middle">
                  <thead class="table-dark">
                    <tr>
                      <th>Preview</th><th>Type</th><th>Make & Model</th><th>Year</th><th>Capacity</th><th>Fuel</th><th>Status</th><th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="vehicle-tbody">
                    {% for vehicle in vehicles %}
                    <tr data-id="{{ vehicle.id }}">
                      <td>
                        {% if vehicle.images and vehicle.images|length > 0 %}
                          <img src="{{ vehicle.images[0] }}" class="img-thumb" alt="img">
                        {% else %}
                          <div class="img-thumb d-flex align-items-center justify-content-center small-muted">No image</div>
                        {% endif %}
                      </td>
                      <td>{{ vehicle.vehicle_type }}</td>
                      <td>{{ vehicle.make_model }}</td>
                      <td>{{ vehicle.year or '-' }}</td>
                      <td>{{ vehicle.capacity or '-' }}</td>
                      <td>{{ vehicle.fuel_type or '-' }}</td>
                      <td>
                        {% if vehicle.status == 'Available' %}<span class="badge bg-success">Available</span>
                        {% elif vehicle.status == 'Booked' %}<span class="badge bg-warning">Booked</span>
                        {% elif vehicle.status == 'Maintenance' %}<span class="badge bg-secondary">Maintenance</span>
                        {% else %}<span class="badge bg-danger">{{ vehicle.status }}</span>{% endif %}
                      </td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary edit-vehicle" data-id="{{ vehicle.id }}">Edit</button>
                        <button class="btn btn-sm btn-outline-danger delete-vehicle" data-id="{{ vehicle.id }}">Delete</button>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- ================= Pricing Tab ================= -->
        <div class="tab-pane fade" id="pricing">
          <div class="row g-4">
            <div class="col-lg-4">
              <div class="p-3 bg-white rounded-3">
                <h6 class="mb-3">Add / Edit Pricing Rule</h6>
                <form id="pricing-form">
                  <input type="hidden" name="pricing_id" id="pricing_id">
                  <div class="mb-2">
                    <label class="form-label small-muted">Vehicle Type</label>
                    <input class="form-control" name="vehicle_type" required placeholder="Car">
                  </div>
                  <div class="mb-2">
                    <label class="form-label small-muted">Tier</label>
                    <select class="form-select" name="tier">
                      <option value="tier1">Tier 1</option><option value="tier2">Tier 2</option><option value="tier3">Tier 3</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label small-muted">Base Fare / Hour (â‚¹)</label>
                    <input class="form-control" name="base_fare_per_hour" type="number" step="0.1">
                  </div>
                  <div class="mb-2">
                    <label class="form-label small-muted">Base Fare / Day (â‚¹)</label>
                    <input class="form-control" name="base_fare_per_day" type="number" step="0.1">
                  </div>
                  <div class="mb-2">
                    <label class="form-label small-muted">Vehicle Multiplier</label>
                    <input class="form-control" name="vehicle_multiplier" type="number" step="0.01" value="1.0">
                  </div>
                  <div class="mb-2">
                    <label class="form-label small-muted">Add-ons (JSON)</label>
                    <textarea class="form-control" name="addons" placeholder='{"GPS":50,"Insurance":100}' rows="3"></textarea>
                  </div>
                  <div class="mb-2 row g-2">
                    <div class="col-6"><label class="form-label small-muted">Tax %</label><input class="form-control" name="tax_percent" type="number" step="0.1" value="18"></div>
                    <div class="col-6"><label class="form-label small-muted">Commission %</label><input class="form-control" name="commission_percent" type="number" step="0.1" value="10"></div>
                  </div>
                  <div class="mb-2">
                    <label class="form-label small-muted">Peak Hour Multiplier</label><input class="form-control" name="peak_hour_multiplier" type="number" step="0.01" value="1.0">
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-primary" id="save-pricing" type="submit">Save Pricing</button>
                    <button class="btn btn-ghost" id="reset-pricing" type="button">Reset</button>
                  </div>
                </form>
              </div>
            </div>

            <div class="col-lg-8">
              <h6>Pricing Rules</h6>
              <div style="max-height:540px; overflow:auto;">
                <table class="table table-hover">
                  <thead class="table-dark"><tr><th>Vehicle Type</th><th>Tier</th><th>Base/hr</th><th>Base/day</th><th>Add-ons</th><th>Tax</th><th>Commission</th><th>Peak Mult</th><th>Actions</th></tr></thead>
                  <tbody id="pricing-tbody">
                    {% for p in pricing %}
                    <tr data-id="{{ p.id }}">
                      <td>{{ p.vehicle_type }}</td>
                      <td>{{ p.tier }}</td>
                      <td>â‚¹{{ p.base_fare_per_hour }}</td>
                      <td>â‚¹{{ p.base_fare_per_day }}</td>
                      <td><pre style="margin:0;">{{ p.addons }}</pre></td>
                      <td>{{ p.tax_percent }}%</td>
                      <td>{{ p.commission_percent }}%</td>
                      <td>{{ p.peak_hour_multiplier }}x</td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary edit-pricing" data-id="{{ p.id }}">Edit</button>
                        <button class="btn btn-sm btn-outline-danger delete-pricing" data-id="{{ p.id }}">Delete</button>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- ================= Availability Tab ================= -->
        <div class="tab-pane fade" id="availability">
          <div class="row">
            <div class="col-12">
              <div class="mb-2 d-flex justify-content-between">
                <h6>Vehicle Availability</h6>
                <div>
                  <button class="btn btn-ghost btn-sm" id="refresh-availability">Refresh</button>
                </div>
              </div>

              <div style="max-height:600px; overflow:auto;">
                <table class="table table-hover">
                  <thead class="table-dark"><tr><th>Vehicle</th><th>Status</th><th>Current Ride</th><th>Return Schedule</th><th>Alerts</th><th>Actions</th></tr></thead>
                  <tbody id="availability-tbody">
                    {% for vehicle in vehicles %}
                    <tr data-id="{{ vehicle.id }}">
                      <td>{{ vehicle.vehicle_type }} â€¢ {{ vehicle.make_model }}</td>
                      <td>
                        {% if vehicle.status == 'Available' %}<span class="badge bg-success">Available</span>
                        {% elif vehicle.status == 'Booked' %}<span class="badge bg-warning">Booked</span>
                        {% elif vehicle.status == 'Maintenance' %}<span class="badge bg-secondary">Maintenance</span>
                        {% else %}<span class="badge bg-danger">{{ vehicle.status }}</span>{% endif %}
                      </td>
                      <td>{{ vehicle.current_ride_id or '-' }}</td>
                      <td>{{ vehicle.return_schedule.strftime('%d-%m %H:%M') if vehicle.return_schedule else '-' }}</td>
                      <td>{% if vehicle.overdue %}<span class="text-danger small-muted">Overdue</span>{% endif %}</td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary set-status" data-id="{{ vehicle.id }}">Set Status</button>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>

            </div>
          </div>
        </div>
      </div><!-- tab-content -->
    </div><!-- card-ll -->
  </div><!-- container -->

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // ---------- utilities ----------
  function toast(msg){ alert(msg); } // replace with a nicer toast if desired

  // ---------- Vehicles: save / edit / delete ----------
  $("#vehicle-form").on("submit", function(e){
    e.preventDefault();
    const vid = $("#vehicle_id").val();
    const url = vid ? `/admin/vehicle/${vid}/update` : '/admin/vehicle/add';
    const form = new FormData(this);
    // NOTE: this will send FormData; backend add/update currently expects form fields
    fetch(url, {method:'POST', body: form}).then(r=>r.json()).then(res=>{
      if(res.success) { toast(res.message); location.reload(); }
      else toast(res.error || JSON.stringify(res));
    });
  });

  // reset
  $("#reset-vehicle").click(()=>{ $("#vehicle-form")[0].reset(); $("#vehicle_id").val(''); });

  // click table row -> fill edit form
  $(document).on("click", "#vehicle-tbody tr", function(){
    const id = $(this).data("id");
    fetch(`/admin/vehicle/${id}`).then(r=>r.json()).then(data=>{
      if(data.error) return toast(data.error);
      $("#vehicle_id").val(data._id.$oid || data._id || id);
      $("input[name='vehicle_type']").val(data.vehicle_type || '');
      $("input[name='make_model']").val(data.make_model || '');
      $("input[name='year']").val(data.year || '');
      $("input[name='capacity']").val(data.capacity || '');
      $("input[name='fuel_type']").val(data.fuel_type || '');
      $("input[name='luggage_space']").val(data.luggage_space || '');
      $("select[name='status']").val(data.status || 'Available');
      // images not set here
      // activate vehicles tab so admin sees form
      var tab = new bootstrap.Tab(document.querySelector('#vehicles-tab'));
      tab.show();
      window.scrollTo({top:0, behavior:'smooth'});
    });
  });

  $(document).on("click", ".delete-vehicle", function(e){
    e.stopPropagation();
    const id = $(this).data("id");
    if(!confirm("Delete vehicle?")) return;
    fetch(`/admin/vehicle/${id}/delete`, {method:'POST'}).then(r=>r.json()).then(res=>{
      if(res.success) { toast(res.message); location.reload(); }
      else toast(res.error || 'Error');
    });
  });

  $("#search-vehicle, #filter-status").on("input change", function(){
    const q = $("#search-vehicle").val().toLowerCase();
    const status = $("#filter-status").val();
    $("#vehicle-tbody tr").each(function(){
      const type = $(this).find('td:nth-child(2)').text().toLowerCase();
      const model = $(this).find('td:nth-child(3)').text().toLowerCase();
      const st = $(this).find('td:nth-child(7)').text().trim();
      const match = (type.includes(q) || model.includes(q)) && (status==='' || st===status);
      $(this).toggle(match);
    });
  });

  $("#refresh-list").click(()=>location.reload());

  // ---------- Pricing ----------
  $("#pricing-form").on("submit", function(e){
    e.preventDefault();
    const pid = $("#pricing_id").val();
    const url = pid ? `/admin/vehicle/pricing/${pid}/update` : '/admin/vehicle/pricing/add';
    const data = $(this).serialize();
    fetch(url, {method:'POST', headers: {'Content-Type':'application/x-www-form-urlencoded'}, body: data})
      .then(r=>r.json()).then(res=>{
        if(res.success) { toast(res.message); location.reload(); } else toast(res.error || JSON.stringify(res));
    });
  });

  $(document).on("click", ".edit-pricing", function(){
    const id = $(this).data("id");
    fetch(`/admin/vehicle/pricing/${id}`).then(r=>r.json()).then(data=>{
      if(data.error) return toast(data.error);
      $("#pricing_id").val(data._id.$oid || data._id || id);
      $("input[name='vehicle_type']").val(data.vehicle_type);
      $("select[name='tier']").val(data.tier);
      $("input[name='base_fare_per_hour']").val(data.base_fare_per_hour);
      $("input[name='base_fare_per_day']").val(data.base_fare_per_day);
      $("input[name='vehicle_multiplier']").val(data.vehicle_multiplier);
      $("textarea[name='addons']").val(JSON.stringify(data.addons || {}));
      $("input[name='tax_percent']").val(data.tax_percent);
      $("input[name='commission_percent']").val(data.commission_percent);
      $("input[name='peak_hour_multiplier']").val(data.peak_hour_multiplier);
      var tab = new bootstrap.Tab(document.querySelector('#pricing-tab')); tab.show();
      window.scrollTo({top:0, behavior:'smooth'});
    });
  });

  $(document).on("click", ".delete-pricing", function(){
    const id = $(this).data("id");
    if(!confirm("Delete pricing rule?")) return;
    fetch(`/admin/vehicle/pricing/${id}/delete`, {method:'POST'}).then(r=>r.json()).then(res=>{
      if(res.success) { toast(res.message); location.reload(); } else toast(res.error || 'Error');
    });
  });

  // fetch pricing endpoint placeholder (backend should return JSON)
  // Add endpoints: GET /admin/vehicle/pricing/<id> -> returns JSON object
  // same as vehicle GET - implement server-side

  // ---------- Availability: set status ----------
  $(document).on("click", ".set-status", function(){
    const id = $(this).data("id");
    const s = prompt("Enter new status (Available / Booked / Maintenance / Disabled):", "Maintenance");
    if(!s) return;
    fetch(`/admin/vehicle/${id}/set_status`, {method:'POST', headers: {'Content-Type':'application/x-www-form-urlencoded'}, body: `status=${encodeURIComponent(s)}`})
      .then(r=>r.json()).then(res=>{
        if(res.success) { toast(res.message); location.reload(); } else toast(res.error || 'Error');
      });
  });

  $("#refresh-availability").click(()=>location.reload());

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  
</body>
</html>
