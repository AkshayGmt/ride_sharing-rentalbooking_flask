<!-- templates/driver_navigation.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Driver Navigation</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { height: 68vh; width: 100%; }
    .panel { padding: 12px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
    .flex { display:flex; gap:12px; }
    .left { flex:1; }
    .right { width:340px; }
    .direction-step { padding:6px 8px; border-bottom:1px solid #eee; font-size:14px; }
    .info { margin-bottom:8px; }
    .btn { padding:8px 12px; background:#1976d2; color:#fff; border:none; border-radius:6px; cursor:pointer; text-decoration:none;}
  </style>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key={{ google_js_key }}&libraries=places"></script>
</head>
<body>
  <div class="flex">
    <div class="left">
      <div id="map"></div>
      <div class="panel">
        <div class="info"><strong>Pickup:</strong> <span id="pickup_addr">Loading...</span></div>
        <div class="info"><strong>Drop:</strong> <span id="drop_addr">Loading...</span></div>
        <div class="info"><strong>Distance:</strong> <span id="distance">--</span> km</div>
        <div class="info"><strong>ETA:</strong> <span id="eta">--</span> mins</div>
        <a id="open_in_maps" class="btn" target="_blank">Open in Google Maps App</a>
      </div>
    </div>

    <div class="right">
      <div class="panel">
        <h4>Turn-by-turn</h4>
        <div id="steps" style="max-height:70vh; overflow:auto;"></div>
      </div>
    </div>
  </div>

<script>
const bookingId = "{{ booking_id }}";
const pickup = {lat: {{ pickup.lat }}, lng: {{ pickup.lng }}};
const drop   = {lat: {{ drop.lat }},  lng: {{ drop.lng }}};

let map, directionsService, directionsRenderer, trafficLayer;
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: pickup,
    zoom: 13
  });

  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true });
  trafficLayer = new google.maps.TrafficLayer();
  trafficLayer.setMap(map);

  // marker for pickup and drop
  new google.maps.Marker({ position: pickup, map, label: "P" });
  new google.maps.Marker({ position: drop, map, label: "D" });

  // draw route using server-side directions (traffic-aware)
  fetch(`/api/directions/${bookingId}`)
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        console.error(data);
        alert("Directions error: " + (data.error));
        return;
      }
      const route = data.routes[0];
      // decode polyline to path and draw
      const polyline = google.maps.geometry.encoding.decodePath(route.polyline);
      const path = new google.maps.Polyline({ path: polyline, strokeColor: '#1976d2', strokeWeight: 6, map: map });
      // fit bounds
      const bounds = new google.maps.LatLngBounds();
      polyline.forEach(p => bounds.extend(p));
      map.fitBounds(bounds);

      // distance & eta (duration_in_traffic if provided)
      const distance_km = (route.distance_m / 1000).toFixed(2);
      const duration_min = Math.round((route.duration_in_traffic_s || route.duration_s) / 60);
      document.getElementById('distance').innerText = distance_km;
      document.getElementById('eta').innerText = duration_min;

      // turn-by-turn steps
      const stepsDiv = document.getElementById('steps');
      stepsDiv.innerHTML = "";
      route.steps.forEach((s, idx) => {
        const div = document.createElement('div');
        div.className = 'direction-step';
        div.innerHTML = `<b>${idx+1}.</b> ${s.html_instructions} <span style="float:right">${(s.distance.value/1000).toFixed(2)} km</span>`;
        stepsDiv.appendChild(div);
      });

      // Open in Google Maps link (origin/destination lat,lng)
      const origin = `${pickup.lat},${pickup.lng}`;
      const dest = `${drop.lat},${drop.lng}`;
      const openLink = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&travelmode=driving`;
      document.getElementById('open_in_maps').href = openLink;
    })
    .catch(err => { console.error(err); alert('Directions fetch failed'); });
}
initMap();
</script>
</body>
</html>
